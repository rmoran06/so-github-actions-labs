name: Release

# Trigger: ejecutar cuando se crea un tag que comience con 'v'
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release and Upload Assets
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test
      
      - name: Generate coverage report
        run: npm run test:coverage --if-present
        continue-on-error: true
        env:
          NODE_ENV: test
      
      - name: Get tag name
        id: tag_name
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Package application
        id: package
        run: |
          TAG_NAME="${{ steps.tag_name.outputs.TAG }}"
          PACKAGE_NAME="so-cicd-app-${TAG_NAME}.tar.gz"
          
          echo "Empaquetando aplicaciÃ³n para release ${TAG_NAME}..."
          
          # Crear archivo tar.gz con los componentes necesarios
          tar -czf "${PACKAGE_NAME}" \
            src/ \
            package.json \
            package-lock.json \
            Dockerfile
          
          echo "âœ“ AplicaciÃ³n empaquetada exitosamente: ${PACKAGE_NAME}"
          ls -lh "${PACKAGE_NAME}"
          
          # Guardar nombre del paquete para pasos siguientes
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.tag_name.outputs.TAG }}
          body: |
            ## Release ${{ steps.tag_name.outputs.TAG }}
            
            **Fecha:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### ğŸ“¦ Contenido del Release
            
            Este release incluye:
            - AplicaciÃ³n Node.js/Express
            - Tests automatizados con Jest
            - Dockerfile para containerizaciÃ³n
            - Sistema de logs automÃ¡tico
            - Endpoints de gestiÃ³n de archivos
            
            ### ğŸš€ InstalaciÃ³n
            
            ```bash
            tar -xzf ${{ steps.package.outputs.package_name }}
            npm install
            npm start
            ```
            
            ### ğŸ§ª Testing
            
            ```bash
            npm test
            ```
            
            ---
            
            Generado automÃ¡ticamente por GitHub Actions
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ steps.package.outputs.package_name }}
          asset_name: ${{ steps.package.outputs.package_name }}
          asset_content_type: application/gzip
      
      - name: Release summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            RELEASE CREADO EXITOSAMENTE            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ·ï¸  Tag: ${{ steps.tag_name.outputs.TAG }}"
          echo "ğŸ“¦ Package: ${{ steps.package.outputs.package_name }}"
          echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_name.outputs.TAG }}"
          echo ""
