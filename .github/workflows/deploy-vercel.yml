name: Deploy to Vercel

# Trigger: ejecutar en push a la rama main
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    
    # Solo ejecutar si los secretos estÃ¡n configurados
    if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests before deploy
        run: npm test
        env:
          NODE_ENV: test
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Deploy to Vercel Production
        id: deploy
        run: |
          echo "Iniciando deployment a Vercel..."
          
          DEPLOYMENT_URL=$(vercel --prod \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --yes)
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          
          echo "âœ“ Deployment exitoso: $DEPLOYMENT_URL"
        continue-on-error: true
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Deployment Success
        if: steps.deploy.outcome == 'success'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         DEPLOYMENT EXITOSO A VERCEL              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ URL de producciÃ³n: ${{ steps.deploy.outputs.deployment_url }}"
          echo "âœ“ La aplicaciÃ³n estÃ¡ ahora disponible pÃºblicamente"
          echo ""
          echo "ğŸ“‹ Endpoints disponibles:"
          echo "   - ${{ steps.deploy.outputs.deployment_url }}/"
          echo "   - ${{ steps.deploy.outputs.deployment_url }}/env"
          echo "   - ${{ steps.deploy.outputs.deployment_url }}/health"
          echo "   - ${{ steps.deploy.outputs.deployment_url }}/files"
          echo ""
      
      - name: Deployment Failed - Rollback Instructions
        if: steps.deploy.outcome == 'failure'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           âš ï¸  DEPLOYMENT FALLIDO                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âŒ El deployment a Vercel ha fallado."
          echo ""
          echo "ğŸ“‹ INSTRUCCIONES DE ROLLBACK:"
          echo ""
          echo "OPCIÃ“N 1 - Rollback desde Vercel Dashboard:"
          echo "==========================================="
          echo "1. Accede a Vercel Dashboard: https://vercel.com/dashboard"
          echo "2. Ve a tu proyecto"
          echo "3. Haz clic en la pestaÃ±a 'Deployments'"
          echo "4. Identifica el Ãºltimo deployment estable (con estado 'Ready')"
          echo "5. Haz clic en los tres puntos (...) del deployment estable"
          echo "6. Selecciona 'Promote to Production'"
          echo "7. Confirma la acciÃ³n"
          echo ""
          echo "OPCIÃ“N 2 - Rollback desde Vercel CLI:"
          echo "====================================="
          echo "1. Instala Vercel CLI si no lo tienes: npm i -g vercel"
          echo "2. Lista los deployments anteriores:"
          echo "   vercel ls --token=\$VERCEL_TOKEN"
          echo "3. Identifica el ID del deployment estable"
          echo "4. Ejecuta el rollback:"
          echo "   vercel rollback <deploymentId> --token=\$VERCEL_TOKEN"
          echo ""
          echo "Ejemplo:"
          echo "   vercel rollback dpl_ABC123xyz --token=\$VERCEL_TOKEN"
          echo ""
          echo "---"
          echo ""
          echo "ğŸ” Revisa los logs arriba para identificar la causa del error."
          echo "ğŸ“ Si necesitas ayuda, contacta al equipo de soporte."
          echo ""
          exit 1
