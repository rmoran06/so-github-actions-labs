name: Deploy to Vercel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest

    steps:
      # 1) Comprobar si hay secretos de Vercel configurados
      - name: Check Vercel secrets
        id: check_secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "AlgÃºn secreto de Vercel NO estÃ¡ configurado. Se omitirÃ¡ el despliegue."
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "Todos los secretos de Vercel estÃ¡n configurados. Se ejecutarÃ¡ el despliegue."
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi

      # 2) Checkout solo si NO se va a omitir el deploy
      - name: Checkout code
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20.x
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        run: npm ci
      
      - name: Run tests before deploy
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        run: npm test
        env:
          NODE_ENV: test
      
      - name: Install Vercel CLI
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        run: npm install -g vercel@latest
      
      - name: Deploy to Vercel Production
        if: steps.check_secrets.outputs.skip_deploy == 'false'
        id: deploy
        run: |
          echo "Iniciando deployment a Vercel..."

          DEPLOYMENT_URL=$(vercel --prod \
            --token "${{ secrets.VERCEL_TOKEN }}" \
            --scope "${{ secrets.VERCEL_ORG_ID }}" \
            --yes)

          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

          echo "âœ“ Deployment exitoso: $DEPLOYMENT_URL"
        continue-on-error: true
      
      - name: Deployment Success
        if: steps.check_secrets.outputs.skip_deploy == 'false' && steps.deploy.outcome == 'success'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        âœ… DEPLOYMENT EXITOSO A VERCEL      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ URL de producciÃ³n: ${{ steps.deploy.outputs.deployment_url }}"
          echo ""
      
      - name: Deployment Failed - Rollback Instructions
        if: steps.check_secrets.outputs.skip_deploy == 'false' && steps.deploy.outcome == 'failure'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           âš ï¸  DEPLOYMENT FALLIDO           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âŒ El deployment a Vercel ha fallado."
          echo ""
          echo "ğŸ“‹ INSTRUCCIONES DE ROLLBACK:"
          echo ""
          echo "OPCIÃ“N 1 - Desde el Dashboard de Vercel:"
          echo "1. Ve a https://vercel.com/dashboard"
          echo "2. Entra a tu proyecto."
          echo "3. Abre la pestaÃ±a 'Deployments'."
          echo "4. Busca el Ãºltimo deployment estable (estado 'Ready')."
          echo "5. Haz clic en '...' y selecciona 'Promote to Production'."
          echo ""
          echo "OPCIÃ“N 2 - Desde la CLI de Vercel:"
          echo "1. Instala la CLI:  npm i -g vercel"
          echo "2. Lista los deployments:  vercel ls --token=\$VERCEL_TOKEN"
          echo "3. Ubica el deployment estable."
          echo "4. Ejecuta:  vercel rollback <deploymentId> --token=\$VERCEL_TOKEN"
          echo ""
          exit 1

      - name: Deploy skipped (no secrets configured)
        if: steps.check_secrets.outputs.skip_deploy == 'true'
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” Deploy a Vercel OMITIDO"
          echo "  Motivo: faltan secretos VERCEL_TOKEN / VERCEL_ORG_ID / VERCEL_PROJECT_ID"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
